<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crop Recommender — Tester</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow-lg p-6; }
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-6">
  <div class="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="card">
      <header class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-2xl font-semibold">Crop Recommender — Tester</h1>
          <p class="text-sm text-slate-500">Choose model, tweak features, and get instant predictions.</p>
        </div>
        <div class="text-right">
          <button id="refreshModels" class="px-3 py-1 rounded-md bg-sky-600 text-white text-sm hover:bg-sky-700">Refresh</button>
        </div>
      </header>

      <form id="predictForm" class="space-y-3">
        <label class="block text-sm font-medium text-slate-700">Model</label>
        <select id="model" name="model" class="w-full p-2 rounded-md border" required></select>

        <div class="grid grid-cols-2 gap-3 mt-2">
          <div id="features" class="col-span-2 grid grid-cols-2 gap-3"></div>
        </div>

        <div class="flex gap-2 mt-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700">Predict</button>
          <button type="button" id="example" class="px-4 py-2 bg-slate-200 rounded-md">Load Example</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2 class="text-lg font-medium">Result</h2>
      <div id="resultCard" class="mt-3 p-3 rounded-md border-dashed border-2 border-slate-200 min-h-[220px] flex flex-col justify-start">
        <div class="flex items-center gap-3">
          <div id="predBadge" class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 font-medium">No prediction yet</div>
          <div id="modelLabel" class="text-sm text-slate-500"></div>
        </div>

        <div class="mt-4">
          <h3 class="text-sm font-medium text-slate-600">Crop Probabilities</h3>
          <div id="probs" class="mt-2 text-sm text-slate-700">—</div>
        </div>

        <div class="mt-4">
          <h3 class="text-sm font-medium text-slate-600">Raw JSON</h3>
          <pre id="response" class="mt-2 bg-slate-100 p-3 rounded-md text-sm overflow-auto">{}</pre>
        </div>
      </div>

      <div class="mt-4">
        <h3 class="text-sm font-medium text-slate-600">Quick rows</h3>
        <div class="flex gap-2 mt-2">
          <button class="flex-1 py-1 rounded-md border text-sm" id="rowRice">Example: Rice</button>
          <button class="flex-1 py-1 rounded-md border text-sm" id="clearBtn">Clear</button>
        </div>
      </div>
    </div>
  </div>

<script>
const FEATURE_NAMES = ['N','P','K','temperature','humidity','ph','rainfall'];
const CROP_NAMES = [
  'apple','banana','blackgram','chickpea','coconut','coffee','cotton','grapes','jute','kidneybeans','lentil','maize','mango','mothbeans','mungbean','muskmelon','orange','papaya','pigeonpeas','pomegranate','rice','watermelon'
];

function buildInputs() {
  const container = document.getElementById('features');
  container.innerHTML = '';
  FEATURE_NAMES.forEach(name => {
    const wrapper = document.createElement('div');
    const label = document.createElement('label');
    label.className = 'text-sm text-slate-700 block';
    label.textContent = name;
    const input = document.createElement('input');
    input.type = 'number';
    input.step = 'any';
    input.name = name;
    input.id = name;
    input.className = 'w-full p-2 rounded-md border';
    input.placeholder = name;
    wrapper.appendChild(label);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });
}

async function loadModels() {
  const sel = document.getElementById('model');
  sel.innerHTML = '';
  try {
    const res = await fetch('/models');
    const j = await res.json();
    const list = j.models || [];
    if (list.length===0) {
      const opt = document.createElement('option'); opt.value=''; opt.textContent='(no models found)'; sel.appendChild(opt);
    } else {
      list.forEach(m => { const opt=document.createElement('option'); opt.value=m; opt.textContent=m; sel.appendChild(opt); });
    }
  } catch(err) {
    const opt = document.createElement('option'); opt.value=''; opt.textContent='(error loading models)'; sel.appendChild(opt);
  }
}

function setResult(json){
  const badge = document.getElementById('predBadge');
  const probs = document.getElementById('probs');
  const resp = document.getElementById('response');
  if (json.error) {
    badge.textContent = 'Error';
    badge.className = 'px-3 py-1 rounded-full bg-rose-100 text-rose-700 font-medium';
    probs.textContent = json.error;
    resp.textContent = JSON.stringify(json, null, 2);
    return;
  }
  const pred = (json.prediction && json.prediction[0]) ? json.prediction[0] : (Array.isArray(json.prediction)?json.prediction:json.prediction);
  badge.textContent = pred;
  badge.className = 'px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 font-medium';
  document.getElementById('modelLabel').textContent = json.model || '';

  if (json.probabilities && json.probabilities.length) {
    const arr = json.probabilities[0];
    probs.innerHTML = '';
    arr.forEach((p,i) => {
      if (p * 100 > 0.1) { // Only show > 0.1%
        const row = document.createElement('div');
        row.className = 'flex justify-between text-sm border-b border-slate-100 py-1';
        const cropName = CROP_NAMES[i] || `Class ${i}`;
        row.innerHTML = `<div>${cropName}</div><div>${(p*100).toFixed(2)}%</div>`;
        probs.appendChild(row);
      }
    });
    if (probs.innerHTML.trim() === '') probs.textContent = 'No probabilities > 0.1%';
  } else {
    probs.textContent = 'Not available';
  }
  resp.textContent = JSON.stringify(json, null, 2);
}

function getFormFeatures(){
  const obj = {};
  FEATURE_NAMES.forEach(f => {
    const v = document.getElementById(f).value;
    obj[f] = v === '' ? 0 : Number(v);
  });
  return obj;
}

window.addEventListener('load', ()=>{
  buildInputs();
  loadModels();

  document.getElementById('refreshModels').addEventListener('click', loadModels);

  document.getElementById('predictForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const model = document.getElementById('model').value;
    if (!model) {
      setResult({error:'Select a model first'}); return;
    }
    const features = getFormFeatures();
    const payload = { model, features };
    setResult({});
    try {
      const res = await fetch('/api/predict', {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const j = await res.json();
      setResult(j);
    } catch(err) {
      setResult({error: err.toString()});
    }
  });

  document.getElementById('example').addEventListener('click', ()=>{
    const example = {N:90,P:42,K:43,temperature:20.879744,humidity:82.002744,ph:6.502985,rainfall:202.935536};
    FEATURE_NAMES.forEach(f => { document.getElementById(f).value = example[f]; });
  });

  document.getElementById('rowRice').addEventListener('click', ()=> document.getElementById('example').click());
  document.getElementById('clearBtn').addEventListener('click', ()=> FEATURE_NAMES.forEach(f=>document.getElementById(f).value=''));
});
</script>
</body>
</html>
