<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crop Probability Dashboard</title>
  <style>
    /* Basic Reset & Font */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      padding: 40px 20px;
      background-color: #f4f7f6;
      color: #333;
    }

    .card {
      max-width: 720px;
      margin: auto;
      padding: 24px 32px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      background: #ffffff;
    }

    h2,
    h3 {
      color: #111;
      margin-top: 0;
    }

    h3 {
      margin-top: 24px;
      font-size: 1.1rem;
    }

    /* Form Styles */
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #dcdcdc;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0 20px;
      margin-top: 16px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      padding: 10px 16px;
      transition: 0.2s;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
      width: 100%;
      margin-top: 10px;
      padding: 14px;
      font-size: 1rem;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background: #f1f3f5;
      color: #333;
      border: 1px solid #ddd;
      font-size: 0.85rem;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      margin-top: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    /* --- NEW: Prediction Result Styles --- */
    .result-container {
      margin-top: 30px;
      display: none;
    }

    .prediction-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .pred-label {
      width: 120px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .pred-bar-bg {
      flex-grow: 1;
      height: 12px;
      background-color: #e9ecef;
      border-radius: 6px;
      overflow: hidden;
      margin: 0 12px;
    }

    .pred-bar-fill {
      height: 100%;
      background-color: #28a745;
      width: 0%;
      transition: width 1s ease-in-out;
    }

    /* Make the top result blue and others green/grey */
    .prediction-item:first-child .pred-bar-fill {
      background-color: #007bff;
    }

    .pred-value {
      width: 60px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: #555;
    }

    /* Gemini Section */
    .ai-section {
      margin-top: 24px;
      display: none;
      padding: 20px;
      background: #fbf9ff;
      border: 1px solid #e0cffc;
      border-radius: 8px;
    }

    .btn-ai {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: inline-flex;
      gap: 8px;
      margin-top: 15px;
    }
  </style>
</head>

<body>

  <div class="card">
    <h2>Crop Prediction Dashboard</h2>

    <form id="predictForm">
      <label>Select Model</label>
      <select name="model">
        {% if models %}
        {% for m in models %}<option value="{{m}}">{{m}}</option>{% endfor %}
        {% else %}
        <option value="">(No models found)</option>
        {% endif %}
      </select>

      <div class="header-row">
        <h3>Features</h3>
        <button type="button" id="fillExampleBtn" class="btn-secondary">Fill Example</button>
      </div>

      <div class="feature-grid">
        {% for f in features %}
        <div>
          <label>{{f}}</label>
          <input name="{{f}}" id="{{f}}" required placeholder="0.0" step="any" />
        </div>
        {% endfor %}
      </div>

      <button type="submit" class="btn-primary">Predict Probabilities</button>
    </form>

    <div id="resultContainer" class="result-container">
      <h3>Analysis Results</h3>
      <div id="barsContainer"></div>

      <div id="aiControls" style="display: none; gap: 10px; align-items: center; margin-top: 20px;">
        <select id="languageSelector" style="width: auto; padding: 10px; margin-bottom: 0; border: 1px solid #ccc;">
          <option value="English">English</option>
          <option value="Hindi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
          <option value="Urdu">Urdu (ÿßÿ±ÿØŸà)</option>
          <option value="Spanish">Spanish (Espa√±ol)</option>
          <option value="French">French (Fran√ßais)</option>
          <option value="Bengali">Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
          <option value="Marathi">Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
          <option value="Tamil">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
          <option value="Telugu">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
        </select>

        <button id="askGeminiBtn" class="btn-ai" style="margin-top: 0;">
          <span>‚ú®</span> Ask Gemini: Why this crop?
        </button>
      </div>

      <div id="aiSection" class="ai-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <strong>Gemini Analysis:</strong>

          <div id="audioControls">
            <button id="speakBtn" class="btn-secondary" style="display:none; font-size: 0.8rem; padding: 4px 8px;">
              üîä Listen
            </button>

            <button id="stopBtn" class="btn-secondary"
              style="display:none; font-size: 0.8rem; padding: 4px 8px; background-color: #fff5f5; color: #d73a49; border-color: #d73a49;">
              üõë Stop
            </button>
          </div>
        </div>

        <p id="aiContent" style="white-space: pre-line; margin-top: 10px;"></p>
        <audio id="audioPlayer" style="display:none"></audio>
      </div>
    </div>
  </div>


  <script>
    let lastData = null;
    let lastTopPrediction = null;

    // Fill Example
    document.getElementById('fillExampleBtn').addEventListener('click', () => {
      const defaults = { "N": 85, "P": 58, "K": 41, "temperature": 21.77, "humidity": 80.31, "ph": 7.03, "rainfall": 226.65 };
      for (let k in defaults) { if (document.getElementById(k)) document.getElementById(k).value = defaults[k]; }
    });

    // Predict Logic
    document.getElementById('predictForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(e.target);
      lastData = Object.fromEntries(data.entries());

      const container = document.getElementById('resultContainer');
      const barsDiv = document.getElementById('barsContainer');
      const aiControls = document.getElementById('aiControls');
      const aiSection = document.getElementById('aiSection');
      const speakBtn = document.getElementById('speakBtn');

      // Reset UI
      container.style.display = 'block';
      barsDiv.innerHTML = '<p style="color:#666">Calculating probabilities...</p>';
      aiControls.style.display = 'none';
      aiSection.style.display = 'none';
      speakBtn.style.display = 'none'; // Hide speak button on new search

      try {
        const resp = await fetch('/predict', { method: 'POST', body: data });
        const json = await resp.json();

        barsDiv.innerHTML = '';
        lastTopPrediction = json.top_prediction;

        json.all_predictions.forEach(item => {
          const row = document.createElement('div');
          row.className = 'prediction-item';
          row.innerHTML = `
                    <div class="pred-label">${item.crop}</div>
                    <div class="pred-bar-bg"><div class="pred-bar-fill" style="width: ${item.probability}%"></div></div>
                    <div class="pred-value">${item.probability}%</div>
                `;
          barsDiv.appendChild(row);
        });
        aiControls.style.display = 'flex';
      } catch (err) {
        barsDiv.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
      }
    });

    // ... (Previous code for predictForm remains the same) ...

    // Gemini Logic
    document.getElementById('askGeminiBtn').addEventListener('click', async () => {
        const aiSection = document.getElementById('aiSection');
        const aiContent = document.getElementById('aiContent');
        const speakBtn = document.getElementById('speakBtn');
        const stopBtn = document.getElementById('stopBtn');
        const audioPlayer = document.getElementById('audioPlayer');
        const language = document.getElementById('languageSelector').value;
        
        // Reset UI
        aiSection.style.display = 'block';
        speakBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        
        aiContent.textContent = `Analyzing soil data in ${language}...`;

        try {
            // 1. Get Explanation
            const response = await fetch('/explain', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    features: lastData, 
                    prediction: lastTopPrediction,
                    language: language 
                })
            });
            const data = await response.json();
            aiContent.textContent = data.explanation;
            
            // Show Listen Button
            speakBtn.style.display = 'inline-block';
            speakBtn.textContent = "üîä Listen";

            // --- AUDIO LOGIC ---
            
            // 2. Handle "Listen" Click
            speakBtn.onclick = async () => {
                speakBtn.textContent = "‚è≥ Loading...";
                speakBtn.disabled = true;

                try {
                    const audioResp = await fetch('/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            text: data.explanation, 
                            language: language 
                        })
                    });
                    
                    if (!audioResp.ok) throw new Error('Audio failed');

                    const blob = await audioResp.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                    
                    // Toggle Buttons
                    speakBtn.style.display = 'none'; // Hide Listen
                    stopBtn.style.display = 'inline-block'; // Show Stop
                    speakBtn.disabled = false;
                    speakBtn.textContent = "üîä Listen"; // Reset text for next time

                } catch (err) {
                    speakBtn.textContent = "Error";
                    speakBtn.disabled = false;
                    console.error(err);
                }
            };

            // 3. Handle "Stop" Click
            stopBtn.onclick = () => {
                audioPlayer.pause();
                audioPlayer.currentTime = 0; // Rewind to start
                stopBtn.style.display = 'none';
                speakBtn.style.display = 'inline-block';
            };

            // 4. Handle Audio Finishing Naturally
            audioPlayer.onended = () => {
                stopBtn.style.display = 'none';
                speakBtn.style.display = 'inline-block';
            };

        } catch (err) {
            aiContent.textContent = 'AI Error: ' + err.message;
        }
    });
  </script>
</body>

</html>

</body>

</html>